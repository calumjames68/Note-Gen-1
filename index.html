<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteTemplate BTGroup</title>
    <!-- Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Global Styles & Variables --- */
        :root {
            --primary-color: #019ba5; /* Updated EE Color */
            --bt-purple: #5514b4;     /* Updated BT Purple */
            --secondary-color: #6c757d;
            --background-color: #f4f7f6;
            --container-bg-color: #ffffff;
            --text-color: #333;
            --border-color: #ccc;
            --focus-shadow: 0 0 0 3px rgba(1, 155, 165, 0.25);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(to right, var(--bt-purple) 40%, var(--primary-color) 60%);
            color: white;
            text-align: center;
            padding: 1.5rem 1rem;
            margin-bottom: 2rem;
        }

        /* --- Main Layout --- */
        .main-container {
            display: grid;
            grid-template-columns: 1fr; /* Single column by default for mobile */
            gap: 2rem;
            padding: 0 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Two-column layout for wider screens */
        @media (min-width: 992px) {
            .main-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* --- Section Styling --- */
        .form-section, .output-section {
            background-color: var(--container-bg-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        h2 {
            margin-bottom: 1rem;
            color: var(--bt-purple);
            border-bottom: 2px solid var(--background-color);
            padding-bottom: 0.5rem;
        }

        /* --- Form Step Styling --- */
        .form-step h3 {
            margin-bottom: 1rem;
            font-weight: 500;
            position: relative;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        #step-1-container h3 {
             cursor: pointer;
        }
         #step-1-container h3::after {
            content: 'âˆ’'; /* Minus sign for expanded state */
            position: absolute;
            right: 5px;
            font-size: 1.5em;
            font-weight: bold;
        }

        #step-1-container.collapsed h3::after {
            content: '+'; /* Plus sign for collapsed state */
        }
        
        .step-content {
            padding-top: 1rem;
            max-height: 1000px; /* Adjust as needed */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding-top 0.5s ease-in-out, visibility 0s 0.5s;
        }

        #step-1-container.collapsed .step-content {
            max-height: 0;
            padding-top: 0;
            visibility: hidden;
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label,
        fieldset legend {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input[type="text"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="text"]:focus,
        input[type="tel"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: var(--focus-shadow);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* --- Checkbox & Radio Styling --- */
        .choice-group label {
             display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0.5rem;
            font-weight: 400;
        }
        
        .inline-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .inline-input-group label {
            margin-bottom: 0;
            white-space: nowrap;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .choice-group input[type="radio"],
        .choice-group input[type="checkbox"],
        .checkbox-group input[type="checkbox"],
        .callback-label input[type="checkbox"] {
            margin-right: 0.75rem;
            height: 1.1em;
            width: 1.1em;
        }
        
        .checkbox-group label,
        .callback-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0.5rem;
            font-weight: 400;
        }


        /* --- Button Styling --- */
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        button:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: #017a82; /* Darker shade of the new EE color */
        }

        .btn-secondary {
            background-color: #e9ecef;
            color: var(--text-color);
            border: 1px solid #ced4da;
        }
        .btn-secondary:hover {
            background-color: #d8dde2;
        }

        /* --- Search Results Styling --- */
        .form-group {
            position: relative; /* Needed for positioning the search results */
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 10;
            max-height: 120px; /* Reduced max-height further to ensure scrollbar appears */
            overflow-y: auto;
        }
        .search-result-item {
            padding: 0.75rem;
            cursor: pointer;
        }
        .search-result-item:hover {
            background-color: #f1f1f1;
        }
        .search-result-item strong {
            color: var(--bt-purple);
        }

        .case-reference-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* --- DI Outcome Section Consistency --- */
        .di-outcome-item {
            margin-bottom: 0.75rem;
        }

        .di-outcome-item label {
             margin-bottom: 0;
        }


        .case-reference-item label {
            margin-bottom: 0; /* Override default label margin */
            white-space: nowrap;
            flex-shrink: 0;
            width: 130px; /* Set a fixed width to align the input boxes */
        }
        .case-reference-item input[type="text"] {
            flex-grow: 1;
        }

        /* --- Condensed Contact Attempts --- */
        .contact-attempts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
        }
        .contact-attempts-grid .form-group {
            margin-bottom: 0;
        }

        /* --- Callback Scheduler Styling (Shared) --- */
        .calendar-container {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 1rem;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
        }
        .month-year-display {
            font-weight: 500;
        }
        .calendar-header button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 0.5rem;
        }
        .calendar-weekdays, .calendar-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
        }
        .calendar-weekdays .weekday {
            font-weight: 500;
            font-size: 0.8rem;
            padding: 0.25rem 0;
        }
        .calendar-body .date-cell {
            padding: 0.5rem 0;
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s;
            position: relative;
        }
        .calendar-body .date-cell:hover:not(.other-month) {
            background-color: #e9ecef;
        }
        .calendar-body .date-cell.other-month {
            color: #ccc;
            cursor: default;
        }
        .calendar-body .date-cell.today::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: var(--bt-purple);
        }
        .calendar-body .date-cell.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        .time-picker-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .time-picker-container select {
            flex-grow: 1;
        }
        .time-picker-container span {
            font-weight: bold;
        }


        /* --- Output Section --- */
        #output-note {
            width: 100%;
            height: 400px; /* Increased height */
            padding: 1rem;
            font-family: monospace;
            font-size: 0.95rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: #f8f9fa;
            margin-bottom: 1rem;
            white-space: pre-wrap; /* Ensures text wraps correctly */
            line-height: 1.4;
        }
        
        /* --- Notification Pop-up Styling --- */
        .notification-popup {
            position: fixed;
            bottom: -100px; /* Start off-screen */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bt-purple);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, bottom 0.4s ease, visibility 0.4s;
        }

        .notification-popup.show {
            bottom: 30px;
            opacity: 1;
            visibility: visible;
        }

        /* --- Modal Styling --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        .modal-overlay:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--container-bg-color);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
            transform: translateY(-50px);
            transition: transform 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content {
             transform: translateY(0);
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--secondary-color);
            cursor: pointer;
            line-height: 1;
        }

        .modal-content h3 {
            color: var(--bt-purple);
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .modal-content p {
            margin-bottom: 1rem;
        }
        
        .modal-link {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.2s;
            text-align: center;
        }
        .modal-link:hover {
            background-color: #017a82;
        }


        /* Utility class for hiding elements */
        .hidden {
            display: none !important; /* Use important to override other styles */
        }
    </style>
</head>
<body>

    <header>
        <h1>NoteTemplate BTGroup</h1>
    </header>

    <main class="main-container">

        <!-- Input Form Section -->
        <section class="form-section">
            <form id="note-form" novalidate>
                
                <!-- STEP 1: BUSINESS AREA -->
                <div id="step-1-container" class="form-step">
                    <h3>Step 1: Select your business area</h3>
                    <div class="step-content">
                        <div class="form-group choice-group">
                            <label><input type="radio" name="business-area" value="Connections"> Connections</label>
                            <label><input type="radio" name="business-area" value="Offline"> Offline</label>
                            <label><input type="radio" name="business-area" value="DI"> DI</label>
                            <label><input type="radio" name="business-area" value="Callbacks"> Callbacks</label>
                        </div>
                    </div>
                </div>

                <!-- STANDARD WORKFLOW CONTAINER -->
                <div id="main-workflow-container" class="hidden">
                    <!-- STEP 2: VALIDATION -->
                    <div id="step-2-container" class="form-step">
                        <h3>Step 2: Have you validated the customer?</h3>
                        <div class="step-content">
                            <div class="form-group choice-group">
                                <label><input type="radio" name="validation" value="yes" id="validate-yes"> Yes</label>
                                <label><input type="radio" name="validation" value="no" id="validate-no"> No</label>
                            </div>
                        </div>
                    </div>
                    <!-- ... (rest of standard workflow) ... -->
                    <div id="validation-no-path" class="form-step hidden">
                        <h3>Step 3: Reason for Failure</h3>
                        <div class="step-content">
                            <div class="form-group">
                                <label for="validation-fail-reason">Why was validation not completed?</label>
                                <textarea id="validation-fail-reason" rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                    <div id="validation-yes-path" class="hidden">
                        <div id="step-3-container" class="form-step">
                            <h3>Step 3: Customer Details & Issue Summary</h3>
                            <div class="step-content">
                                <div class="form-group">
                                    <label for="cust-name">Customer Name</label>
                                    <input type="text" id="cust-name" name="cust-name">
                                </div>
                                <div class="form-group">
                                    <label for="account-number">Account Number</label>
                                    <input type="text" id="account-number" name="account-number">
                                </div>
                                <div class="form-group">
                                    <label for="phone-number">Phone Number</label>
                                    <input type="tel" id="phone-number" name="phone-number">
                                </div>
                                <div class="form-group">
                                    <label for="issue-summary">Issue Summary</label>
                                    <textarea id="issue-summary" name="issue-summary" rows="5"></textarea>
                                </div>
                            </div>
                        </div>
                        <div id="step-4-container" class="form-step">
                            <h3>Step 4: Actions Taken</h3>
                            <div class="step-content">
                                <fieldset class="form-group">
                                    <div class="checkbox-group">
                                        <label><input type="checkbox" name="action" value="Checked Security Questions"> Checked Security Questions</label>
                                        <label><input type="checkbox" name="action" value="Updated Account Details"> Updated Account Details</label>
                                        <label><input type="checkbox" name="action" value="Provided Troubleshooting Steps"> Provided Troubleshooting Steps</label>
                                        <label><input type="checkbox" name="action" value="Explained Next Steps"> Explained Next Steps</label>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div id="step-5-container" class="form-step">
                            <h3>Step 5: Outcome & Next Steps</h3>
                            <div class="step-content">
                                <div class="form-group">
                                    <label class="callback-label"><input type="checkbox" id="callback-booked"> Callback Booked?</label>
                                </div>
                                <div class="form-group hidden" id="callback-scheduler-container">
                                    <label>Select Callback Date & Time</label>
                                    <div id="calendar-container" class="calendar-container">
                                        <div class="calendar-header">
                                            <button type="button" id="prev-month-btn">&lt;</button>
                                            <span id="month-year-display" class="month-year-display"></span>
                                            <button type="button" id="next-month-btn">&gt;</button>
                                        </div>
                                        <div class="calendar-weekdays">
                                            <div class="weekday">Mon</div><div class="weekday">Tue</div><div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div><div class="weekday">Sun</div>
                                        </div>
                                        <div id="calendar-body" class="calendar-body"></div>
                                    </div>
                                    <div id="callback-times-container" class="time-picker-container">
                                        <select id="main-hour-picker"></select>
                                        <span>:</span>
                                        <select id="main-minute-picker"></select>
                                    </div>
                                    <input type="hidden" id="callback-details" name="callback-details">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OFFLINE WORKFLOW CONTAINER -->
                <div id="offline-workflow-container" class="hidden">
                    <div class="form-step">
                        <h3>Offline: Delay Details</h3>
                        <div class="step-content">
                            <div class="form-group">
                                <label for="delay-error-code">Enter or Search for Delay Error Code</label>
                                <input type="text" id="delay-error-code" autocomplete="off">
                                <div id="error-code-results" class="search-results hidden"></div>
                            </div>
                            <div class="form-group choice-group">
                                <label><input type="checkbox" id="add-second-code-checkbox"> Add second error code</label>
                            </div>
                            <div class="form-group hidden" id="second-error-code-container">
                                <label for="delay-error-code-2">Enter or Search for Second Delay Error Code</label>
                                <input type="text" id="delay-error-code-2" autocomplete="off">
                                <div id="error-code-results-2" class="search-results hidden"></div>
                            </div>
                             <div class="form-group" id="delay-reason-group">
                                <label for="delay-reason">Reason for Delay</label>
                                <select id="delay-reason">
                                    <option value="" selected disabled>Select delay reason...</option>
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>
                            <div class="form-group choice-group">
                                <label><input type="checkbox" id="no-delay-checkbox"> No Delay?</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-step">
                        <h3>Offline: Customer Contact</h3>
                        <div class="step-content">
                            <div class="form-group">
                                <label>Customer Answered?</label>
                                <div class="choice-group">
                                    <label><input type="radio" name="customer-answered" value="Yes"> Yes</label>
                                    <label><input type="radio" name="customer-answered" value="No"> No</label>
                                </div>
                            </div>
                            <div class="form-group" id="customer-verified-group">
                                <label>Customer Verified?</label>
                                <div class="choice-group">
                                    <label><input type="radio" name="customer-verified" value="Yes"> Yes</label>
                                    <label><input type="radio" name="customer-verified" value="No"> No</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-step">
                        <h3>Offline: Contact Attempts (SMS)</h3>
                        <div class="step-content contact-attempts-grid">
                            <div class="form-group">
                                <label>Pre Text Sent?</label>
                                <div class="choice-group">
                                    <label><input type="radio" name="pre-text-sent" value="Yes"> Yes</label>
                                    <label><input type="radio" name="pre-text-sent" value="No"> No</label>
                                </div>
                            </div>
                             <div class="form-group">
                                <label>Post Text Sent?</label>
                                <div class="choice-group">
                                    <label><input type="radio" name="post-text-sent" value="Yes"> Yes</label>
                                    <label><input type="radio" name="post-text-sent" value="No"> No</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-step">
                        <h3>Offline: Resolution Status</h3>
                        <div class="step-content">
                            <div class="form-group choice-group">
                                <label><input type="checkbox" id="offline-resolved"> #Resolved</label>
                            </div>
                             <div class="form-group inline-input-group">
                                <label for="offline-number-input">#</label>
                                <input type="text" id="offline-number-input" placeholder="Enter number...">
                            </div>
                        </div>
                    </div>
                     <div class="form-step">
                        <h3>Offline: Callback?</h3>
                        <div class="step-content">
                             <div class="form-group">
                                <label class="callback-label"><input type="checkbox" id="offline-callback-booked"> Book callback?</label>
                            </div>
                            <div class="form-group hidden" id="offline-callback-scheduler-container">
                                <label>Select Callback Date & Time</label>
                                <div id="offline-calendar-container" class="calendar-container">
                                    <div class="calendar-header">
                                        <button type="button" id="offline-prev-month-btn">&lt;</button>
                                        <span id="offline-month-year-display" class="month-year-display"></span>
                                        <button type="button" id="offline-next-month-btn">&gt;</button>
                                    </div>
                                    <div class="calendar-weekdays">
                                        <div class="weekday">Mon</div><div class="weekday">Tue</div><div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div><div class="weekday">Sun</div>
                                    </div>
                                    <div id="offline-calendar-body" class="calendar-body"></div>
                                </div>
                                <div id="offline-callback-times-container" class="time-picker-container">
                                      <select id="offline-hour-picker"></select>
                                      <span>:</span>
                                      <select id="offline-minute-picker"></select>
                                </div>
                                <input type="hidden" id="offline-callback-details" name="offline-callback-details">
                            </div>
                        </div>
                    </div>
                    <div class="form-step">
                        <h3>Offline: Additional Info</h3>
                        <div class="step-content">
                            <div class="form-group">
                                <label for="additional-info">Enter any additional info</label>
                                <textarea id="additional-info" rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DI WORKFLOW CONTAINER -->
                <div id="di-workflow-container" class="hidden">
                    <div class="form-step">
                        <h3>DI: Initial Call Details</h3>
                        <div class="step-content">
                            <div class="form-group">
                                <label>Call from Guide?</label>
                                <div class="choice-group">
                                    <label><input type="radio" name="di-call-from-guide" value="Yes"> Yes</label>
                                    <label><input type="radio" name="di-call-from-guide" value="No"> No</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>What Brand?</label>
                                <div class="choice-group">
                                    <label><input type="radio" name="di-brand" value="BT"> BT</label>
                                    <label><input type="radio" name="di-brand" value="EE"> EE</label>
                                </div>
                            </div>
                            <div class="form-group hidden" id="di-cold-transfer-group">
                                <div class="checkbox-group">
                                     <label><input type="checkbox" id="di-cold-transfer"> Cold Transfer?</label>
                                </div>
                            </div>
                            <div class="form-group hidden" id="di-albert-flow-group">
                                <label for="di-albert-flow">Albert Flow Used</label>
                                <select id="di-albert-flow">
                                    <option value="" selected disabled>Select a flow...</option>
                                    <option value="">999</option>
                                    <option value="Amend">Address matching</option>
                                    <option value="">Billing</option>
                                    <option value="Amend">BT to New EE regrades</option>
                                    <option value="">Error code or message</option>
                                    <option value="">Escalation</option>
                                    <option value="">Faults</option>
                                    <option value="">Find a Fix</option>
                                    <option value="">Incorrect referral</option>
                                    <option value="Create">Orders</option>
                                    <option value="Amend">Package/Promotion</option>
                                    <option value="Amend">Product</option>
                                    <option value="Amend">One Touch Switching</option>
                                </select>
                            </div>
                            <div class="form-group hidden" id="di-correct-flow-group">
                                <label>Is this a DI issue?</label>
                                <div class="choice-group">
                                    <label><input type="radio" name="di-correct-flow" value="Yes"> Yes</label>
                                    <label><input type="radio" name="di-correct-flow" value="No"> No</label>
                                </div>
                            </div>
                             <div class="form-group hidden" id="di-referred-to-group">
                                <label>What department have you referred the guide to?</label>
                                <div class="choice-group">
                                    <label><input type="radio" name="di-referred-to" value="Billing"> Billing</label>
                                    <label><input type="radio" name="di-referred-to" value="Sales"> Sales</label>
                                    <label><input type="radio" name="di-referred-to" value="Connections"> Connections</label>
                                </div>
                            </div>
                            <div class="form-group" id="di-issue-summary-group">
                                <label for="di-issue-summary">DI Issue Summary</label>
                                <textarea id="di-issue-summary" rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-step">
                        <h3>DI: Outcome & Next Steps</h3>
                        <div class="step-content">
                             <div class="form-group">
                                <div class="di-outcome-item case-reference-item">
                                    <label class="callback-label"><input type="checkbox" id="di-ordi-checkbox" name="di-case-type" value="ORDI"> ORDI</label>
                                    <input type="text" id="di-ordi-reference" class="hidden" placeholder="ORDI Reference...">
                                </div>
                                <div class="di-outcome-item case-reference-item">
                                    <label class="callback-label"><input type="checkbox" id="di-bridge-case-checkbox" name="di-case-type" value="Bridge Case"> Bridge Case</label>
                                    <input type="text" id="di-bridge-case-reference" class="hidden" placeholder="Bridge Case Reference...">
                                </div>
                            </div>
                             <div class="form-group di-outcome-item">
                                <label class="callback-label"><input type="checkbox" id="di-referral-form"> Incorrect Referral Form Raised?</label>
                            </div>
                            <div class="form-group di-outcome-item">
                                <label class="callback-label"><input type="checkbox" id="di-callback-booked"> Callback Booked?</label>
                            </div>
                            <div class="form-group hidden" id="di-callback-scheduler-container">
                                <label>Select Callback Date & Time</label>
                                <div class="calendar-container">
                                    <div class="calendar-header">
                                        <button type="button" id="di-prev-month-btn">&lt;</button>
                                        <span id="di-month-year-display" class="month-year-display"></span>
                                        <button type="button" id="di-next-month-btn">&gt;</button>
                                    </div>
                                    <div class="calendar-weekdays">
                                        <div class="weekday">Mon</div><div class="weekday">Tue</div><div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div><div class="weekday">Sun</div>
                                    </div>
                                    <div id="di-calendar-body" class="calendar-body"></div>
                                </div>
                                <div class="time-picker-container">
                                    <select id="di-hour-picker"></select>
                                    <span>:</span>
                                    <select id="di-minute-picker"></select>
                                </div>
                                <input type="hidden" id="di-callback-details">
                            </div>
                             <div class="form-group">
                                <label for="di-next-actions">Next Actions</label>
                                <textarea id="di-next-actions" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn-primary">Generate Note</button>
                    <button type="reset" class="btn-secondary">Clear Form</button>
                </div>

            </form>
        </section>

        <!-- Output Section -->
        <section class="output-section">
            <h2>Generated Note</h2>
            <textarea id="output-note" readonly placeholder="Your generated note will appear here..."></textarea>
            <button id="copy-button" class="btn-secondary" style="margin-top: 1rem;">Copy to Clipboard</button>
        </section>

    </main>
    
    <!-- Universal Info Modal -->
    <div id="info-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button type="button" class="modal-close-btn">&times;</button>
            <h3 id="info-modal-title"></h3>
            <p id="info-modal-text"></p>
            <div id="info-modal-link-container" class="hidden">
                <p>Please use the link below to complete the form:</p>
                <a href="https://forms.office.com/pages/responsepage.aspx?id=iFbzpwCcXk26QSnxRjd6sNgLHVkoLC9BtSpITX1NlXBUOFBUNFo1U0wzVldENTVMQ1lVNEpYSFkxMC4u&route=shorturl" target="_blank" rel="noopener noreferrer" class="modal-link">Open Referral Form</a>
            </div>
        </div>
    </div>

    <div id="notification-popup" class="notification-popup"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DATA ---
            const delayReasonsData = [
                { id: 'ducting_issue', category: 'Delays', dropdownText: 'External Ducting Issue (12 Weeks)'},
                { id: 'engineer_shortage', category: 'Delays', dropdownText: 'Engineer Shortage (4 Weeks)'},
                { id: 'wayleave_delay', category: 'Delays', dropdownText: 'Wayleave/Permit Delay (8 Weeks)'},
                { id: 'damaged_cabinet', category: 'Delays', dropdownText: 'Damaged Cabinet (12 Weeks)'},
                { id: 'damaged_pole', category: 'Delays', dropdownText: 'Damaged Pole (12 Weeks)'},
                { id: 'developer_delays', category: 'Delays', dropdownText: 'Developer Delays (3 Weeks)'},
                { id: 'duct_cable_stock', category: 'Delays', dropdownText: 'Duct and Cable Stock (3 Weeks)'},
                { id: 'e_d_side_fault', category: 'Delays', dropdownText: 'E-side or D-side Fault (20 Days)'},
                { id: 'hoist_availability', category: 'Delays', dropdownText: 'Hoist Availability (3 Weeks)'},
                { id: 'no_capacity', category: 'Delays', dropdownText: 'No Capacity Available (12 Weeks)'},
                { id: 'planning_design', category: 'Delays', dropdownText: 'Planning and Design (30 Days)'},
                { id: 'ptw_delay', category: 'Delays', dropdownText: 'PTW (Permission to Work) Delay'},
                { id: 'open_exception', category: 'Delays', dropdownText: 'Open Exception (7 Days)'},
                { id: 'routing_issue', category: 'Delays', dropdownText: 'Routing Issue (14 Days)'},
                { id: 'survey_required', category: 'Delays', dropdownText: 'Survey Required (30 Days)'},
                { id: 'tree_cutting', category: 'Delays', dropdownText: 'Tree Cutting (13 Weeks)'},
            ];
            const mockErrorDatabase = [
                { code: '521', description: "Changes to appointment" },
                { code: '523', description: "New appointment required" },
                { code: '524', description: "New appointment required" },
                { code: '525', description: "Changes to appointment" },
                { code: '566', description: "New appointment required" },
                { code: '584', description: "Further work required" },
                { code: '585', description: "Further work required" },
                { code: '586', description: "Survey" },
                { code: '2001', description: "Contact details supplied don't match database" },
                { code: '5045', description: "Changes to appointment" },
                { code: '5197', description: "New appointment required" },
                { code: '5466', description: "Planning and design" },
                { code: '5472', description: "New appointment required" },
                { code: '5742', description: "Survey" },
                { code: '5789', description: "Changes to appointment" },
                { code: '9652-2', description: "Planning and design" },
                { code: '9652-4', description: "Planning and design" },
                { code: '9662', description: "Delayed in Planning" },
                { code: '9775-1', description: "Further work required" },
                { code: '9775-1', description: "New appointment required" },
                { code: '9798', description: "Engineer unable to complete work" },
                { code: '9881', description: "Engineer unable to complete work" },
                { code: '100221', description: "Haven't sent a new appointment within 15 days of request" },
                { code: '100313', description: "No asset for given ALID (order needs to be cancelled and replaced)" },
                { code: '101002', description: "Planning and design" },
                { code: '101003', description: "Awaiting D share routing" },
                { code: '101018', description: "PSTN delay" },
                { code: '101021', description: "Delayed in Planning" },
                { code: '101031', description: "Openreach querying whether to proceed with the order" },
                { code: '101074', description: "Further work required" },
                { code: '101075', description: "Openreach is waiting for information from the CP (Communications Provider)" },
                { code: '101078', description: "Network build status update (Ready to build, Installing, Complete, etc.)" },
                { code: '101082', description: "Line plant delay" },
                { code: '101084', description: "Issues with the underground network" },
                { code: '101092', description: "Required work exceeded the time allocation; new appointment needed" },
                { code: '101093', description: "Further work is needed by Openreach" },
                { code: '101095', description: "Fault on the distribution side network" },
                { code: '101107', description: "Survey" },
                { code: '101110', description: "Safety-related hazard" },
                { code: '101115', description: "Planning and design" },
                { code: '101116', description: "Planning and design" },
                { code: '101130', description: "New appointment required" },
                { code: '101131', description: "New appointment required" },
                { code: '101132', description: "Additional build works impacting order; re-appointment needed" },
                { code: '101133', description: "Additional Traffic Management Act (TMA) impact; re-appointment needed" },
                { code: '101134', description: "Order on waiters list due to network capacity issues" },
                { code: '101146', description: "End Customer provided instructions different to those from the CP" },
                { code: '101147', description: "Engineer missed the slot or was unable to complete the installation" },
                { code: '101148', description: "Engineer missed the slot or was unable to complete the installation" },
                { code: '101153', description: "Engineer missed the slot or was unable to complete the installation" },
                { code: '101158', description: "Appointment missed due to an End Customer missed scenario" },
                { code: '101160', description: "Order passed to Network Addressing Team (NAT) to identify the address" },
                { code: '101161', description: "Order requires a survey (various reasons)" },
                { code: '101163', description: "Delayed in Planning" },
                { code: '101165', description: "The original routing is unavailable; working on an alternative" },
                { code: '101165', description: "Order has been identified as a new site by BT Wholesale" },
                { code: '101166', description: "Planning and design" },
                { code: '101171', description: "Appointment missed due to an End Customer missed scenario" }
            ];

            // --- Element Selectors ---
            const noteForm = document.getElementById('note-form');
            const outputNoteTextarea = document.getElementById('output-note');
            const copyButton = document.getElementById('copy-button');
            const notificationPopup = document.getElementById('notification-popup');
            
            // Step containers and paths
            const step1Container = document.getElementById('step-1-container');
            const businessAreaRadios = document.querySelectorAll('input[name="business-area"]');
            const mainWorkflowContainer = document.getElementById('main-workflow-container');
            const offlineWorkflowContainer = document.getElementById('offline-workflow-container');
            const diWorkflowContainer = document.getElementById('di-workflow-container'); // DI container
            const validationYesPath = document.getElementById('validation-yes-path');
            const validationNoPath = document.getElementById('validation-no-path');
            const validationRadios = document.querySelectorAll('input[name="validation"]');

            // Form field selectors (Standard)
            const custNameInput = document.getElementById('cust-name');
            const accountNumberInput = document.getElementById('account-number');
            const phoneNumberInput = document.getElementById('phone-number');
            const issueSummaryInput = document.getElementById('issue-summary');
            const validationFailReasonInput = document.getElementById('validation-fail-reason');
            
            // Offline workflow selectors
            const delayErrorCodeInput = document.getElementById('delay-error-code');
            const delayReasonSelect = document.getElementById('delay-reason');
            const delayReasonGroup = document.getElementById('delay-reason-group');
            const noDelayCheckbox = document.getElementById('no-delay-checkbox');
            const errorCodeResultsContainer = document.getElementById('error-code-results');
            const addSecondCodeCheckbox = document.getElementById('add-second-code-checkbox');
            const secondErrorCodeContainer = document.getElementById('second-error-code-container');
            const delayErrorCodeInput2 = document.getElementById('delay-error-code-2');
            const errorCodeResultsContainer2 = document.getElementById('error-code-results-2');
            const additionalInfoInput = document.getElementById('additional-info');
            const offlineResolvedCheckbox = document.getElementById('offline-resolved');
            const offlineNumberInput = document.getElementById('offline-number-input');
            const customerAnsweredRadios = document.querySelectorAll('input[name="customer-answered"]');
            const customerVerifiedGroup = document.getElementById('customer-verified-group');

            // DI Workflow Selectors
            const diCallFromGuideRadios = document.querySelectorAll('input[name="di-call-from-guide"]');
            const diAlbertFlowGroup = document.getElementById('di-albert-flow-group');
            const diAlbertFlowSelect = document.getElementById('di-albert-flow');
            const diCorrectFlowGroup = document.getElementById('di-correct-flow-group');
            const diCorrectFlowRadios = document.querySelectorAll('input[name="di-correct-flow"]');
            const diReferredToGroup = document.getElementById('di-referred-to-group');
            const diColdTransferGroup = document.getElementById('di-cold-transfer-group');
            const diColdTransferCheckbox = document.getElementById('di-cold-transfer');
            const diReferralFormCheckbox = document.getElementById('di-referral-form');
            const diIssueSummaryGroup = document.getElementById('di-issue-summary-group');
            const diCaseTypeCheckboxes = document.querySelectorAll('input[name="di-case-type"]');
            const diCaseDetailsGroup = document.getElementById('di-case-details-group');
            const diOrdiCheckbox = document.getElementById('di-ordi-checkbox');
            const diOrdiReference = document.getElementById('di-ordi-reference');
            const diBridgeCaseCheckbox = document.getElementById('di-bridge-case-checkbox');
            const diBridgeCaseReference = document.getElementById('di-bridge-case-reference');
            
            // Universal Modal Selectors
            const infoModal = document.getElementById('info-modal');
            const infoModalTitle = document.getElementById('info-modal-title');
            const infoModalText = document.getElementById('info-modal-text');
            const infoModalLinkContainer = document.getElementById('info-modal-link-container');
            const infoModalCloseBtn = infoModal.querySelector('.modal-close-btn');


            // Callback selectors (Standard Workflow)
            const callbackBookedCheckbox = document.getElementById('callback-booked');
            const callbackSchedulerContainer = document.getElementById('callback-scheduler-container');
            const callbackDetailsInput = document.getElementById('callback-details');
            const mainHourPicker = document.getElementById('main-hour-picker');
            const mainMinutePicker = document.getElementById('main-minute-picker');
            const monthYearDisplay = document.getElementById('month-year-display');
            const calendarBody = document.getElementById('calendar-body');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');

            // Callback selectors (Offline Workflow)
            const offlineCallbackBookedCheckbox = document.getElementById('offline-callback-booked');
            const offlineCallbackSchedulerContainer = document.getElementById('offline-callback-scheduler-container');
            const offlineCallbackDetailsInput = document.getElementById('offline-callback-details');
            const offlineHourPicker = document.getElementById('offline-hour-picker');
            const offlineMinutePicker = document.getElementById('offline-minute-picker');
            const offlineMonthYearDisplay = document.getElementById('offline-month-year-display');
            const offlineCalendarBody = document.getElementById('offline-calendar-body');
            const offlinePrevMonthBtn = document.getElementById('offline-prev-month-btn');
            const offlineNextMonthBtn = document.getElementById('offline-next-month-btn');
            
            // Callback selectors (DI Workflow)
            const diCallbackBookedCheckbox = document.getElementById('di-callback-booked');
            const diCallbackSchedulerContainer = document.getElementById('di-callback-scheduler-container');
            const diCallbackDetailsInput = document.getElementById('di-callback-details');
            const diHourPicker = document.getElementById('di-hour-picker');
            const diMinutePicker = document.getElementById('di-minute-picker');
            const diMonthYearDisplay = document.getElementById('di-month-year-display');
            const diCalendarBody = document.getElementById('di-calendar-body');
            const diPrevMonthBtn = document.getElementById('di-prev-month-btn');
            const diNextMonthBtn = document.getElementById('di-next-month-btn');
            
            
            // --- INITIALIZATION ---
            
            // Populate delay reasons dropdown
            delayReasonsData.forEach(reason => {
                const option = document.createElement('option');
                option.value = reason.id;
                option.textContent = reason.dropdownText;
                delayReasonSelect.appendChild(option);
            });
            
            // --- Reusable Functions ---
            const formatDateTimeForNote = (date) => {
                if (!date) return 'N/A';
                const d = new Date(date);
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = String(d.getFullYear()).slice(-2);
                const hours = String(d.getHours()).padStart(2, '0');
                const minutes = String(d.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            };


            /**
             * Shows a notification pop-up at the bottom of the screen.
             * @param {string} message - The message to display.
             * @param {boolean} [isSuccess=true] - Determines the background color.
             */
            const showNotification = (message, isSuccess = true) => {
                notificationPopup.textContent = message;
                notificationPopup.style.backgroundColor = isSuccess ? 'var(--primary-color)' : '#d9534f'; // Use primary color for success, red for failure
                notificationPopup.classList.add('show');

                // Hide the notification after 3 seconds
                setTimeout(() => {
                    notificationPopup.classList.remove('show');
                }, 3000);
            };

            /**
             * Copies the content of the output note textarea to the clipboard
             * and provides visual feedback to the user via a pop-up.
             */
            const copyNoteToClipboard = () => {
                if (outputNoteTextarea.value.length === 0) return;

                try {
                    outputNoteTextarea.select();
                    outputNoteTextarea.setSelectionRange(0, 99999); // For mobile devices
                    document.execCommand('copy');
                    showNotification('Note copied to clipboard!');
                } catch (e) {
                    console.error('Failed to copy text: ', e);
                    showNotification('Failed to copy note!', false);
                }
                // Deselect the text after the operation
                window.getSelection().removeAllRanges();
            };
            
            // --- Calendar & Time Picker Logic ---
            let selectedDateMain = null;
            let selectedDateOffline = null;
            let selectedDateDI = null;

            const setupTimePicker = (hourPicker, minutePicker, hiddenInput, dateRef, startHour, endHour, minuteIncrement) => {
                let hourOptions = '';
                let minuteOptions = '';

                const defaultHour = String(startHour).padStart(2, '0');

                for (let i = startHour; i <= endHour; i++) {
                    const hour = String(i).padStart(2, '0');
                    hourOptions += `<option value="${hour}" ${hour === defaultHour ? 'selected' : ''}>${hour}</option>`;
                }

                for (let i = 0; i < 60; i += minuteIncrement) {
                    const minute = String(i).padStart(2, '0');
                    minuteOptions += `<option value="${minute}" ${minute === '00' ? 'selected' : ''}>${minute}</option>`;
                }

                hourPicker.innerHTML = hourOptions;
                minutePicker.innerHTML = minuteOptions;
                
                const updateHiddenInput = () => {
                    if (dateRef && hourPicker.value && minutePicker.value) {
                        hiddenInput.value = `${dateRef.getFullYear()}-${String(dateRef.getMonth() + 1).padStart(2, '0')}-${String(dateRef.getDate()).padStart(2, '0')} ${hourPicker.value}:${minutePicker.value}`;
                    } else {
                        hiddenInput.value = '';
                    }
                };
                
                updateHiddenInput();

                hourPicker.addEventListener('change', updateHiddenInput);
                minutePicker.addEventListener('change', updateHiddenInput);
            };

            const renderCalendar = (year, month, calendarBodyEl, monthYearDisplayEl, onDateSelect) => {
                calendarBodyEl.innerHTML = '';
                const firstDayOfMonth = new Date(year, month, 1);
                const lastDateOfMonth = new Date(year, month + 1, 0);
                const lastDateOfPrevMonth = new Date(year, month, 0);

                monthYearDisplayEl.textContent = firstDayOfMonth.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });

                let firstDayIndex = firstDayOfMonth.getDay(); 
                if (firstDayIndex === 0) firstDayIndex = 7; 

                for (let i = firstDayIndex - 1; i > 0; i--) {
                    const day = lastDateOfPrevMonth.getDate() - i + 1;
                    const cell = document.createElement('div');
                    cell.classList.add('date-cell', 'other-month');
                    cell.textContent = day;
                    calendarBodyEl.appendChild(cell);
                }

                for (let i = 1; i <= lastDateOfMonth.getDate(); i++) {
                    const cell = document.createElement('div');
                    cell.classList.add('date-cell');
                    cell.textContent = i;
                    
                    const today = new Date();
                    if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                        cell.classList.add('today');
                    }

                    cell.addEventListener('click', () => {
                        calendarBodyEl.querySelectorAll('.date-cell.selected').forEach(c => c.classList.remove('selected'));
                        cell.classList.add('selected');
                        const selectedDate = new Date(year, month, i);
                        onDateSelect(selectedDate);
                    });
                    calendarBodyEl.appendChild(cell);
                }
            };
            
            // Setup Main Calendar
            let main_currentDate = new Date();
            let main_currentYear = main_currentDate.getFullYear();
            let main_currentMonth = main_currentDate.getMonth();
            prevMonthBtn.addEventListener('click', () => {
                main_currentMonth--;
                if (main_currentMonth < 0) { main_currentMonth = 11; main_currentYear--; }
                renderCalendar(main_currentYear, main_currentMonth, calendarBody, monthYearDisplay, (date) => {
                     selectedDateMain = date;
                     setupTimePicker(mainHourPicker, mainMinutePicker, callbackDetailsInput, selectedDateMain, 8, 20, 5);
                });
            });
            nextMonthBtn.addEventListener('click', () => {
                main_currentMonth++;
                if (main_currentMonth > 11) { main_currentMonth = 0; main_currentYear++; }
                renderCalendar(main_currentYear, main_currentMonth, calendarBody, monthYearDisplay, (date) => {
                    selectedDateMain = date;
                    setupTimePicker(mainHourPicker, mainMinutePicker, callbackDetailsInput, selectedDateMain, 8, 20, 5);
                });
            });

            // Setup Offline Calendar
            let offline_currentDate = new Date();
            let offline_currentYear = offline_currentDate.getFullYear();
            let offline_currentMonth = offline_currentDate.getMonth();
            offlinePrevMonthBtn.addEventListener('click', () => {
                offline_currentMonth--;
                if (offline_currentMonth < 0) { offline_currentMonth = 11; offline_currentYear--; }
                renderCalendar(offline_currentYear, offline_currentMonth, offlineCalendarBody, offlineMonthYearDisplay, (date) => {
                    selectedDateOffline = date;
                    setupTimePicker(offlineHourPicker, offlineMinutePicker, offlineCallbackDetailsInput, selectedDateOffline, 8, 21, 5);
                });
            });
            offlineNextMonthBtn.addEventListener('click', () => {
                offline_currentMonth++;
                if (offline_currentMonth > 11) { offline_currentMonth = 0; offline_currentYear++; }
                renderCalendar(offline_currentYear, offline_currentMonth, offlineCalendarBody, offlineMonthYearDisplay, (date) => {
                    selectedDateOffline = date;
                    setupTimePicker(offlineHourPicker, offlineMinutePicker, offlineCallbackDetailsInput, selectedDateOffline, 8, 21, 5);
                });
            });
            
            // Setup DI Calendar
            let di_currentDate = new Date();
            let di_currentYear = di_currentDate.getFullYear();
            let di_currentMonth = di_currentDate.getMonth();
            diPrevMonthBtn.addEventListener('click', () => {
                di_currentMonth--;
                if (di_currentMonth < 0) { di_currentMonth = 11; di_currentYear--; }
                renderCalendar(di_currentYear, di_currentMonth, diCalendarBody, diMonthYearDisplay, (date) => {
                    selectedDateDI = date;
                    setupTimePicker(diHourPicker, diMinutePicker, diCallbackDetailsInput, selectedDateDI, 8, 21, 15);
                });
            });
            diNextMonthBtn.addEventListener('click', () => {
                di_currentMonth++;
                if (di_currentMonth > 11) { di_currentMonth = 0; di_currentYear++; }
                renderCalendar(di_currentYear, di_currentMonth, diCalendarBody, diMonthYearDisplay, (date) => {
                    selectedDateDI = date;
                    setupTimePicker(diHourPicker, diMinutePicker, diCallbackDetailsInput, selectedDateDI, 8, 21, 15);
                });
            });

            // --- Error Code Search Functionality ---
            const setupSearch = (inputElement, resultsContainer) => {
                inputElement.addEventListener('input', () => {
                    const query = inputElement.value.trim().toLowerCase();
                    resultsContainer.innerHTML = ''; // Clear previous results

                    if (query.length < 1) {
                        resultsContainer.classList.add('hidden');
                        return;
                    }

                    let finalResults = [];
                    const noCodeResult = { code: 'No Code', description: 'No specific error code provided' };

                    if (noCodeResult.code.toLowerCase().includes(query) || noCodeResult.description.toLowerCase().includes(query)) {
                        finalResults.push(noCodeResult);
                    }

                    const filteredDb = mockErrorDatabase.filter(item =>
                        item.code.toLowerCase().includes(query) || item.description.toLowerCase().includes(query)
                    );
                    finalResults = finalResults.concat(filteredDb);
                    
                    if (finalResults.length > 0) {
                        finalResults.forEach(result => {
                            const item = document.createElement('div');
                            item.classList.add('search-result-item');
                            item.innerHTML = `<strong>${result.code}</strong> - ${result.description}`;
                            item.addEventListener('click', () => {
                                inputElement.value = result.code;
                                resultsContainer.classList.add('hidden');
                            });
                            resultsContainer.appendChild(item);
                        });
                        resultsContainer.classList.remove('hidden');
                    } else {
                         resultsContainer.classList.add('hidden');
                    }
                });
                 // Hide search results when clicking elsewhere
                 document.addEventListener('click', (event) => {
                     if (!inputElement.contains(event.target)) {
                        resultsContainer.classList.add('hidden');
                     }
                 });
            };

            setupSearch(delayErrorCodeInput, errorCodeResultsContainer);
            setupSearch(delayErrorCodeInput2, errorCodeResultsContainer2);


            // --- EVENT LISTENERS ---

            // 1. Business area selection
            businessAreaRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    const selectedValue = event.target.value;
                    mainWorkflowContainer.classList.add('hidden');
                    offlineWorkflowContainer.classList.add('hidden');
                    diWorkflowContainer.classList.add('hidden');
                    
                    if (selectedValue === 'Offline') {
                        offlineWorkflowContainer.classList.remove('hidden');
                        step1Container.classList.add('collapsed');
                    } else if (selectedValue === 'DI') {
                        diWorkflowContainer.classList.remove('hidden');
                        step1Container.classList.add('collapsed');
                    } else {
                        mainWorkflowContainer.classList.remove('hidden');
                        step1Container.classList.remove('collapsed');
                    }
                });
            });

            // 2. Expand/collapse Step 1
            step1Container.querySelector('h3').addEventListener('click', () => {
                step1Container.classList.toggle('collapsed');
            });


            // 3. Validation radio buttons (standard workflow)
            validationRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'yes') {
                        validationYesPath.classList.remove('hidden');
                        validationNoPath.classList.add('hidden');
                    } else {
                        validationNoPath.classList.remove('hidden');
                        validationYesPath.classList.add('hidden');
                    }
                });
            });

            // 4. Conditional logic for Customer Verified section (Offline Workflow)
            customerAnsweredRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'No') {
                        customerVerifiedGroup.classList.add('hidden');
                    } else {
                        customerVerifiedGroup.classList.remove('hidden');
                    }
                });
            });
            
            // 5. Checkbox for second error code
            addSecondCodeCheckbox.addEventListener('change', () => {
                secondErrorCodeContainer.classList.toggle('hidden');
                if (!addSecondCodeCheckbox.checked) {
                    delayErrorCodeInput2.value = ''; // Clear on hide
                }
            });

            // 6. Checkbox for "No Delay?"
            noDelayCheckbox.addEventListener('change', () => {
                if (noDelayCheckbox.checked) {
                    delayReasonGroup.classList.add('hidden');
                    delayReasonSelect.value = ''; // Reset selection
                } else {
                    delayReasonGroup.classList.remove('hidden');
                }
            });

            // 7. DI Workflow conditional logic
            diCallFromGuideRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const fromGuide = e.target.value === 'Yes';
                    diAlbertFlowGroup.classList.toggle('hidden', !fromGuide);
                    diCorrectFlowGroup.classList.toggle('hidden', !fromGuide);
                    diColdTransferGroup.classList.toggle('hidden', fromGuide);

                    if (!fromGuide) {
                       diReferredToGroup.classList.add('hidden');
                       diAlbertFlowSelect.value = '';
                       document.querySelector('input[name="di-correct-flow"][value="Yes"]').checked = false;
                       document.querySelector('input[name="di-correct-flow"][value="No"]').checked = false;
                    } else {
                       diColdTransferCheckbox.checked = false;
                       diReferralFormCheckbox.checked = false;
                       diIssueSummaryGroup.classList.remove('hidden');
                    }
                });
            });

            diColdTransferCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    diReferralFormCheckbox.checked = true;
                    infoModalTitle.textContent = 'Incorrect Referral';
                    infoModalText.textContent = 'Because this was a cold transfer, an incorrect referral form must be raised.';
                    infoModalLinkContainer.classList.remove('hidden');
                    infoModal.classList.remove('hidden');
                }
            });

            diCorrectFlowRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isNotDiIssue = e.target.value === 'No';
                    diReferredToGroup.classList.toggle('hidden', !isNotDiIssue);
                    diIssueSummaryGroup.classList.toggle('hidden', isNotDiIssue);
                    if (isNotDiIssue) {
                        diReferralFormCheckbox.checked = true;
                        infoModalTitle.textContent = 'Action Required';
                        infoModalText.textContent = 'This is not a DI issue. Please refer the customer to the correct department and raise an incorrect referral form.';
                        infoModalLinkContainer.classList.remove('hidden');
                        infoModal.classList.remove('hidden');
                    } else {
                        if (!diColdTransferCheckbox.checked) {
                            diReferralFormCheckbox.checked = false;
                        }
                    }
                });
            });
            
            diOrdiCheckbox.addEventListener('change', () => {
                diOrdiReference.classList.toggle('hidden', !diOrdiCheckbox.checked);
                 if (!diOrdiCheckbox.checked) diOrdiReference.value = '';
            });

            diBridgeCaseCheckbox.addEventListener('change', () => {
                diBridgeCaseReference.classList.toggle('hidden', !diBridgeCaseCheckbox.checked);
                if (!diBridgeCaseCheckbox.checked) diBridgeCaseReference.value = '';
            });

            // Close modal listeners
            const closeModal = () => infoModal.classList.add('hidden');
            infoModalCloseBtn.addEventListener('click', closeModal);
            infoModal.addEventListener('click', (e) => {
                if (e.target === infoModal) { // Only close if overlay is clicked
                    closeModal();
                }
            });

            // 8. Handle form submission
            noteForm.addEventListener('submit', (event) => {
                event.preventDefault();

                const selectedArea = document.querySelector('input[name="business-area"]:checked')?.value;
                let finalNote = '';
                
                const formatLine = (key, value) => `${key.padEnd(20, ' ')}: ${value || 'N/A'}`;

                if (selectedArea === 'Offline') {
                    // --- OFFLINE NOTE GENERATION ---
                    const delayErrorCode1 = delayErrorCodeInput.value.trim();
                    const delayErrorCode2 = delayErrorCodeInput2.value.trim();
                    
                    let combinedErrorCodes = delayErrorCode1;
                    if (!combinedErrorCodes || combinedErrorCodes === "No Code") {
                        combinedErrorCodes = "No Code Provided";
                    }

                    if(delayErrorCode2 && delayErrorCode2 !== "No Code") {
                        combinedErrorCodes += `, ${delayErrorCode2}`;
                    }

                    let delayReasonText;
                    if (noDelayCheckbox.checked) {
                        delayReasonText = "No Delay";
                    } else {
                        delayReasonText = delayReasonSelect.options[delayReasonSelect.selectedIndex].text;
                    }
                    
                    const preTextSent = document.querySelector('input[name="pre-text-sent"]:checked')?.value || 'N/A';
                    const customerAnswered = document.querySelector('input[name="customer-answered"]:checked')?.value || 'N/A';
                    let customerVerified = document.querySelector('input[name="customer-verified"]:checked')?.value || 'N/A';
                    
                    if (customerAnswered === 'No') {
                        customerVerified = 'No'; // Override if customer didn't answer
                    }
                    
                    const postTextSent = document.querySelector('input[name="post-text-sent"]:checked')?.value || 'N/A';
                    
                    const isResolved = offlineResolvedCheckbox.checked;
                    const numberValue = offlineNumberInput.value.trim();
                    const additionalInfo = additionalInfoInput.value.trim();
                    
                    const callbackBooked = offlineCallbackBookedCheckbox.checked;
                    let callbackDetailsText = 'No';
                     if (callbackBooked && offlineCallbackDetailsInput.value) {
                          callbackDetailsText = `Yes - ${formatDateTimeForNote(offlineCallbackDetailsInput.value)}`;
                    } else if (callbackBooked) {
                          callbackDetailsText = `Yes (No time selected)`;
                    }


                    let hashtags = [];
                    if (isResolved) {
                        hashtags.push('#Resolved');
                    }
                    if (numberValue) {
                        hashtags.push(`#${numberValue}`);
                    }
                    
                    const contactAttempts = `Answered: ${customerAnswered} | Verified: ${customerVerified}`;
                    const smsAttempts = `Pre-Text: ${preTextSent} | Post-Text: ${postTextSent}`;

                    finalNote = `
---[ OFFLINE WORKFLOW ]----------------------------------
${formatLine('Business Area', 'Offline')}
${formatLine('Delay Error Code(s)', combinedErrorCodes)}
${formatLine('Delay Reason', delayReasonText.includes('Select') ? 'N/A' : delayReasonText)}
${formatLine('Contact Summary', contactAttempts)}
${formatLine('SMS Summary', smsAttempts)}
${formatLine('Callback Booked', callbackDetailsText)}
${formatLine('Resolution', hashtags.join(' ') || 'N/A')}

---[ ADDITIONAL INFO ]-----------------------------------

${additionalInfo || 'No additional info provided.'}
                    `.trim();

                } else if (selectedArea === 'DI') {
                    // --- DI NOTE GENERATION ---
                    const diCallFromGuide = document.querySelector('input[name="di-call-from-guide"]:checked')?.value;
                    const diBrand = document.querySelector('input[name="di-brand"]:checked')?.value;
                    const diAlbertFlow = diAlbertFlowSelect.options[diAlbertFlowSelect.selectedIndex]?.text || 'N/A';
                    const isDiIssue = document.querySelector('input[name="di-correct-flow"]:checked')?.value;
                    const referredToDept = document.querySelector('input[name="di-referred-to"]:checked')?.value;
                    const isColdTransfer = diColdTransferCheckbox.checked ? 'Yes' : 'No';
                    
                    const diRequestType = diAlbertFlowSelect.value || 'N/A';
                    
                    const nextActions = document.getElementById('di-next-actions').value.trim();
                    const referralFormRaised = document.getElementById('di-referral-form').checked ? 'Yes' : 'No';
                    
                    const callbackBooked = diCallbackBookedCheckbox.checked;
                    let callbackDetailsText = 'No';
                     if (callbackBooked && diCallbackDetailsInput.value) {
                          callbackDetailsText = `Yes - ${formatDateTimeForNote(diCallbackDetailsInput.value)}`;
                    } else if (callbackBooked) {
                          callbackDetailsText = `Yes (No time selected)`;
                    }
                   
                    let flowDetails = '';
                    if (diCallFromGuide === 'Yes') {
                        flowDetails += `\n${formatLine('Albert Flow', diAlbertFlow.includes('Select') ? 'N/A' : diAlbertFlow)}`;
                        flowDetails += `\n${formatLine('Is a DI issue?', isDiIssue)}`;
                        if (isDiIssue === 'No') {
                           flowDetails += `\n${formatLine('Referred To', referredToDept)}`;
                        }
                    } else if (diCallFromGuide === 'No') {
                        flowDetails += `\n${formatLine('Cold Transfer?', isColdTransfer)}`;
                    }

                    let issueSummarySection = '';
                    if (isDiIssue !== 'No') {
                        const diIssueSummary = document.getElementById('di-issue-summary').value.trim();
                        issueSummarySection = `
---[ ISSUE SUMMARY ]-------------------------------------

${diIssueSummary || 'No summary provided.'}
`;
                    }

                    let outcomeLines = [];
                    outcomeLines.push(formatLine('Request Type', diRequestType));

                    if (diOrdiCheckbox.checked && diOrdiReference.value.trim()) {
                        outcomeLines.push(formatLine('ORDI Reference', diOrdiReference.value.trim()));
                    }
                    if (diBridgeCaseCheckbox.checked && diBridgeCaseReference.value.trim()) {
                        outcomeLines.push(formatLine('Bridge Case Ref', diBridgeCaseReference.value.trim()));
                    }

                    outcomeLines.push(formatLine('Incorrect Referral?', referralFormRaised));
                    outcomeLines.push(formatLine('Callback Booked?', callbackDetailsText));


                    finalNote = `
---[ DI WORKFLOW ]---------------------------------------
${formatLine('Business Area', 'DI')}
${formatLine('Brand', diBrand)}
${formatLine('Call From Guide?', diCallFromGuide)}${flowDetails}
${issueSummarySection}
---[ OUTCOME & NEXT STEPS ]------------------------------
${outcomeLines.join('\n')}

Next Actions:
${nextActions || 'No next actions specified.'}
                    `.trim().replace(/^\s*\n/gm, ''); // clean up empty lines

                } else {
                    // --- STANDARD NOTE GENERATION ---
                    const validateYes = document.getElementById('validate-yes').checked;
                    if (validateYes) {
                        const customerName = custNameInput.value.trim();
                        const accountNumber = accountNumberInput.value.trim();
                        const phoneNumber = phoneNumberInput.value.trim();
                        const issueSummary = issueSummaryInput.value.trim();
                        const checkedActions = document.querySelectorAll('input[name="action"]:checked');
                        
                        let actionsText = '';
                        if (checkedActions.length > 0) {
                            actionsText = `\n---[ ACTIONS TAKEN ]-------------------------------------\n\n`;
                            checkedActions.forEach(checkbox => {
                                actionsText += `  â€¢ ${checkbox.value}\n`;
                            });
                        }

                        const callbackBooked = callbackBookedCheckbox.checked;
                        let callbackDetailsText = 'No';
                        if (callbackBooked && callbackDetailsInput.value) {
                             callbackDetailsText = `Yes - ${formatDateTimeForNote(callbackDetailsInput.value)}`;
                        } else if (callbackBooked) {
                             callbackDetailsText = `Yes (No time selected)`;
                        }

                        finalNote = `
---[ CALL DETAILS ]--------------------------------------
${formatLine('Business Area', selectedArea)}

---[ CUSTOMER & ACCOUNT ]--------------------------------
${formatLine('Customer Name', customerName)}
${formatLine('Account Number', accountNumber)}
${formatLine('Phone Number', phoneNumber)}

---[ ISSUE SUMMARY ]-------------------------------------

${issueSummary || 'No summary provided.'}
${actionsText}
---[ OUTCOME & NEXT STEPS ]------------------------------
${formatLine('Callback Booked', callbackDetailsText)}
`.trim();

                    } else {
                        const reason = validationFailReasonInput.value.trim();
                        finalNote = `
---[ CALL DETAILS ]--------------------------------------
${formatLine('Business Area', selectedArea)}

---[ VALIDATION NOT COMPLETED ]--------------------------

Customer validation was not completed.

Reason:
${reason || 'No reason provided.'}
`.trim();
                    }
                }
                
                outputNoteTextarea.value = finalNote;
                copyNoteToClipboard(); // Auto-copy the note to clipboard
            });

            // 9. Toggle visibility of callback schedulers
            callbackBookedCheckbox.addEventListener('change', () => {
                if (callbackBookedCheckbox.checked) {
                    callbackSchedulerContainer.classList.remove('hidden');
                    renderCalendar(main_currentYear, main_currentMonth, calendarBody, monthYearDisplay, (date) => {
                        selectedDateMain = date;
                        setupTimePicker(mainHourPicker, mainMinutePicker, callbackDetailsInput, selectedDateMain, 8, 20, 5);
                    });
                } else {
                    callbackSchedulerContainer.classList.add('hidden');
                    callbackDetailsInput.value = '';
                }
            });
            offlineCallbackBookedCheckbox.addEventListener('change', () => {
                if (offlineCallbackBookedCheckbox.checked) {
                    offlineCallbackSchedulerContainer.classList.remove('hidden');
                     renderCalendar(offline_currentYear, offline_currentMonth, offlineCalendarBody, offlineMonthYearDisplay, (date) => {
                         selectedDateOffline = date;
                         setupTimePicker(offlineHourPicker, offlineMinutePicker, offlineCallbackDetailsInput, selectedDateOffline, 8, 21, 5);
                    });
                } else {
                    offlineCallbackSchedulerContainer.classList.add('hidden');
                    offlineCallbackDetailsInput.value = '';
                }
            });
            diCallbackBookedCheckbox.addEventListener('change', () => {
                if (diCallbackBookedCheckbox.checked) {
                    diCallbackSchedulerContainer.classList.remove('hidden');
                    renderCalendar(di_currentYear, di_currentMonth, diCalendarBody, diMonthYearDisplay, (date) => {
                        selectedDateDI = date;
                        setupTimePicker(diHourPicker, diMinutePicker, diCallbackDetailsInput, selectedDateDI, 8, 21, 15);
                    });
                } else {
                    diCallbackSchedulerContainer.classList.add('hidden');
                    diCallbackDetailsInput.value = '';
                }
            });

            // 10. Handle the "Copy to Clipboard" button click
            copyButton.addEventListener('click', copyNoteToClipboard);

            // 11. Handle form reset
            noteForm.addEventListener('reset', () => {
                outputNoteTextarea.value = '';
                // Hide all main containers
                mainWorkflowContainer.classList.add('hidden');
                offlineWorkflowContainer.classList.add('hidden');
                diWorkflowContainer.classList.add('hidden');
                
                // Reset standard workflow
                validationYesPath.classList.add('hidden');
                validationNoPath.classList.add('hidden');
                callbackSchedulerContainer.classList.add('hidden');
                
                // Reset offline workflow
                offlineCallbackSchedulerContainer.classList.add('hidden');
                customerVerifiedGroup.classList.remove('hidden');
                addSecondCodeCheckbox.checked = false;
                secondErrorCodeContainer.classList.add('hidden');
                delayErrorCodeInput2.value = '';
                noDelayCheckbox.checked = false;
                delayReasonGroup.classList.remove('hidden');
                
                // Reset DI workflow
                diCallbackSchedulerContainer.classList.add('hidden');
                diAlbertFlowGroup.classList.add('hidden');
                diCorrectFlowGroup.classList.add('hidden');
                diReferredToGroup.classList.add('hidden');
                diColdTransferGroup.classList.add('hidden');
                diColdTransferCheckbox.checked = false;
                diIssueSummaryGroup.classList.remove('hidden');
                diOrdiReference.classList.add('hidden');
                diOrdiReference.value = '';
                diBridgeCaseReference.classList.add('hidden');
                diBridgeCaseReference.value = '';
                infoModal.classList.add('hidden');
                
                // Show the first step again
                step1Container.classList.remove('collapsed');
            });
        });
    </script>
</body>
</html>
