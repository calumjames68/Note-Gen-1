<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteTemplate BTGroup</title>
    <!-- Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Global Styles & Variables --- */
        :root {
            --primary-color: #019ba5; /* Updated EE Color */
            --bt-purple: #5514b4;     /* Updated BT Purple */
            --secondary-color: #6c757d;
            --background-color: #f4f7f6;
            --container-bg-color: #ffffff;
            --text-color: #333;
            --border-color: #ccc;
            --focus-shadow: 0 0 0 3px rgba(1, 155, 165, 0.25);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(to right, var(--bt-purple) 40%, var(--primary-color) 60%);
            color: white;
            text-align: center;
            padding: 1.5rem 1rem;
            margin-bottom: 2rem;
        }

        /* --- Main Layout --- */
        .main-container {
            display: grid;
            grid-template-columns: 1fr; /* Single column by default for mobile */
            gap: 2rem;
            padding: 0 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Two-column layout for wider screens */
        @media (min-width: 992px) {
            .main-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* --- Section Styling --- */
        .form-section, .output-section {
            background-color: var(--container-bg-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        h2 {
            margin-bottom: 1rem;
            color: var(--bt-purple);
            border-bottom: 2px solid var(--background-color);
            padding-bottom: 0.5rem;
        }

        /* --- Form Step Styling --- */
        .form-step h3 {
            margin-bottom: 1rem;
            font-weight: 500;
            position: relative;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        #step-1-container h3 {
             cursor: pointer;
        }
         #step-1-container h3::after {
            content: 'âˆ’'; /* Minus sign for expanded state */
            position: absolute;
            right: 5px;
            font-size: 1.5em;
            font-weight: bold;
        }

        #step-1-container.collapsed h3::after {
            content: '+'; /* Plus sign for collapsed state */
        }
        
        .step-content {
            padding-top: 1rem;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding-top 0.5s ease-in-out, visibility 0s 0.5s;
        }

        #step-1-container.collapsed .step-content {
            max-height: 0;
            padding-top: 0;
            visibility: hidden;
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label,
        fieldset legend {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input[type="text"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="text"]:focus,
        input[type="tel"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: var(--focus-shadow);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* --- Checkbox & Radio Styling --- */
        .choice-group label {
             display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0.5rem;
            font-weight: 400;
        }
        
        .inline-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .inline-input-group label {
            margin-bottom: 0;
            white-space: nowrap;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .choice-group input[type="radio"],
        .choice-group input[type="checkbox"],
        .checkbox-group input[type="checkbox"],
        .callback-label input[type="checkbox"] {
            margin-right: 0.75rem;
            height: 1.1em;
            width: 1.1em;
        }
        
        .checkbox-group label,
        .callback-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0.5rem;
            font-weight: 400;
        }


        /* --- Button Styling --- */
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        button:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: #017a82; /* Darker shade of the new EE color */
        }

        .btn-secondary {
            background-color: #e9ecef;
            color: var(--text-color);
            border: 1px solid #ced4da;
        }
        .btn-secondary:hover {
            background-color: #d8dde2;
        }

        /* --- Search Results Styling --- */
        .form-group {
            position: relative; /* Needed for positioning the search results */
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 10;
            max-height: 120px; /* Reduced max-height further to ensure scrollbar appears */
            overflow-y: auto;
        }
        .search-result-item {
            padding: 0.75rem;
            cursor: pointer;
        }
        .search-result-item:hover {
            background-color: #f1f1f1;
        }
        .search-result-item strong {
            color: var(--bt-purple);
        }

        /* --- Condensed Contact Attempts --- */
        .contact-attempts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
        }
        .contact-attempts-grid .form-group {
            margin-bottom: 0;
        }

        /* --- Callback Scheduler Styling (Shared) --- */
        .calendar-container {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 1rem;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
        }
        .month-year-display {
            font-weight: 500;
        }
        .calendar-header button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 0.5rem;
        }
        .calendar-weekdays, .calendar-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
        }
        .calendar-weekdays .weekday {
            font-weight: 500;
            font-size: 0.8rem;
            padding: 0.25rem 0;
        }
        .calendar-body .date-cell {
            padding: 0.5rem 0;
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s;
            position: relative;
        }
        .calendar-body .date-cell:hover:not(.other-month) {
            background-color: #e9ecef;
        }
        .calendar-body .date-cell.other-month {
            color: #ccc;
            cursor: default;
        }
        .calendar-body .date-cell.today::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: var(--bt-purple);
        }
        .calendar-body .date-cell.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        .time-picker-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .time-picker-container select {
            flex-grow: 1;
        }
        .time-picker-container span {
            font-weight: bold;
        }


        /* --- Output Section --- */
        #output-note {
            width: 100%;
            height: 400px; /* Increased height */
            padding: 1rem;
            font-family: monospace;
            font-size: 0.95rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: #f8f9fa;
            margin-bottom: 1rem;
            white-space: pre-wrap; /* Ensures text wraps correctly */
            line-height: 1.4;
        }
        
        /* --- Copy Feedback Styling --- */
        #copy-feedback {
            color: var(--primary-color);
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #copy-feedback.show {
            opacity: 1;
        }

        /* Utility class for hiding elements */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <header>
        <h1>NoteTemplate BTGroup</h1>
    </header>

    <main class="main-container">

        <!-- Input Form Section -->
        <section class="form-section">
            <form id="note-form" novalidate>
                
                <!-- STEP 1: BUSINESS AREA -->
                <div id="step-1-container" class="form-step">
                    <h3>Step 1: Select your business area</h3>
                    <div class="step-content">
                        <div class="form-group choice-group">
                            <label><input type="radio" name="business-area" value="Connections"> Connections</label>
                            <label><input type="radio" name="business-area" value="Offline"> Offline</label>
                            <label><input type="radio" name="business-area" value="DI"> DI</label>
                            <label><input type="radio" name="business-area" value="Callbacks"> Callbacks</label>
                        </div>
                    </div>
                </div>

                <!-- STANDARD WORKFLOW CONTAINER -->
                <div id="main-workflow-container" class="hidden">
                    <!-- STEP 2: VALIDATION -->
                    <div id="step-2-container" class="form-step">
                        <h3>Step 2: Have you validated the customer?</h3>
                        <div class="step-content">
                            <div class="form-group choice-group">
                                <label><input type="radio" name="validation" value="yes" id="validate-yes"> Yes</label>
                                <label><input type="radio" name="validation" value="no" id="validate-no"> No</label>
                            </div>
                        </div>
                    </div>
                    <!-- ... (rest of standard workflow) ... -->
                    <div id="validation-no-path" class="form-step hidden">
                        <h3>Step 3: Reason for Failure</h3>
                        <div class="step-content">
                            <div class="form-group">
                                <label for="validation-fail-reason">Why was validation not completed?</label>
                                <textarea id="validation-fail-reason" rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                    <div id="validation-yes-path" class="hidden">
                        <div id="step-3-container" class="form-step">
                            <h3>Step 3: Customer Details & Issue Summary</h3>
                            <div class="step-content">
                                <div class="form-group">
                                    <label for="cust-name">Customer Name</label>
                                    <input type="text" id="cust-name" name="cust-name">
                                </div>
                                <div class="form-group">
                                    <label for="account-number">Account Number</label>
                                    <input type="text" id="account-number" name="account-number">
                                </div>
                                <div class="form-group">
                                    <label for="phone-number">Phone Number</label>
                                    <input type="tel" id="phone-number" name="phone-number">
                                </div>
                                <div class="form-group">
                                    <label for="issue-summary">Issue Summary</label>
                                    <textarea id="issue-summary" name="issue-summary" rows="5"></textarea>
                                </div>
                            </div>
                        </div>
                        <div id="step-4-container" class="form-step">
                            <h3>Step 4: Actions Taken</h3>
                            <div class="step-content">
                                <fieldset class="form-group">
                                    <div class="checkbox-group">
                                        <label><input type="checkbox" name="action" value="Checked Security Questions"> Checked Security Questions</label>
                                        <label><input type="checkbox" name="action" value="Updated Account Details"> Updated Account Details</label>
                                        <label><input type="checkbox" name="action" value="Provided Troubleshooting Steps"> Provided Troubleshooting Steps</label>
                                        <label><input type="checkbox" name="action" value="Explained Next Steps"> Explained Next Steps</label>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div id="step-5-container" class="form-step">
                            <h3>Step 5: Outcome & Next Steps</h3>
                            <div class="step-content">
                                <div class="form-group">
                                    <label class="callback-label"><input type="checkbox" id="callback-booked"> Callback Booked?</label>
                                </div>
                                <div class="form-group hidden" id="callback-scheduler-container">
                                    <label>Select Callback Date & Time</label>
                                    <div id="calendar-container" class="calendar-container">
                                        <div class="calendar-header">
                                            <button type="button" id="prev-month-btn">&lt;</button>
                                            <span id="month-year-display" class="month-year-display"></span>
                                            <button type="button" id="next-month-btn">&gt;</button>
                                        </div>
                                        <div class="calendar-weekdays">
                                            <div class="weekday">Mon</div><div class="weekday">Tue</div><div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div><div class="weekday">Sun</div>
                                        </div>
                                        <div id="calendar-body" class="calendar-body"></div>
                                    </div>
                                    <div id="callback-times-container" class="time-picker-container">
                                        <select id="main-hour-picker"></select>
                                        <span>:</span>
                                        <select id="main-minute-picker"></select>
                                    </div>
                                    <input type="hidden" id="callback-details" name="callback-details">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OFFLINE WORKFLOW CONTAINER -->
                <div id="offline-workflow-container" class="hidden">
                    <div class="form-step">
                        <h3>Offline: Delay Details</h3>
                        <div class="step-content">
                            <div class="form-group">
                                <label for="delay-error-code">Enter or Search for Delay Error Code</label>
                                <input type="text" id="delay-error-code" autocomplete="off">
                                <div id="error-code-results" class="search-results hidden"></div>
                            </div>
                            <div class="form-group choice-group">
                                <label><input type="checkbox" id="add-second-code-checkbox"> Add second error code</label>
                            </div>
                            <div class="form-group hidden" id="second-error-code-container">
                                <label for="delay-error-code-2">Enter or Search for Second Delay Error Code</label>
                                <input type="text" id="delay-error-code-2" autocomplete="off">
                                <div id="error-code-results-2" class="search-results hidden"></div>
                            </div>
                             <div class="form-group" id="delay-reason-group">
                                <label for="delay-reason">Reason for Delay</label>
                                <select id="delay-reason">
                                    <option value="" selected disabled>Select delay reason...</option>
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>
                            <div class="form-group choice-group">
                                <label><input type="checkbox" id="no-delay-checkbox"> No Delay?</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-step">
                        <h3>Offline: Customer Contact</h3>
                        <div class="step-content">
                            <div class="form-group">
                                <label>Customer Answered?</label>
                                <div class="choice-group">
                                    <label><input type="radio" name="customer-answered" value="Yes"> Yes</label>
                                    <label><input type="radio" name="customer-answered" value="No"> No</label>
                                </div>
                            </div>
                            <div class="form-group" id="customer-verified-group">
                                <label>Customer Verified?</label>
                                <div class="choice-group">
                                    <label><input type="radio" name="customer-verified" value="Yes"> Yes</label>
                                    <label><input type="radio" name="customer-verified" value="No"> No</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-step">
                        <h3>Offline: Contact Attempts (SMS)</h3>
                        <div class="step-content contact-attempts-grid">
                            <div class="form-group">
                                <label>Pre Text Sent?</label>
                                <div class="choice-group">
                                    <label><input type="radio" name="pre-text-sent" value="Yes"> Yes</label>
                                    <label><input type="radio" name="pre-text-sent" value="No"> No</label>
                                </div>
                            </div>
                             <div class="form-group">
                                <label>Post Text Sent?</label>
                                <div class="choice-group">
                                    <label><input type="radio" name="post-text-sent" value="Yes"> Yes</label>
                                    <label><input type="radio" name="post-text-sent" value="No"> No</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-step">
                        <h3>Offline: Resolution Status</h3>
                        <div class="step-content">
                            <div class="form-group choice-group">
                                <label><input type="checkbox" id="offline-resolved"> #Resolved</label>
                            </div>
                             <div class="form-group inline-input-group">
                                <label for="offline-number-input">#</label>
                                <input type="text" id="offline-number-input" placeholder="Enter number...">
                            </div>
                        </div>
                    </div>
                     <div class="form-step">
                        <h3>Offline: Callback?</h3>
                        <div class="step-content">
                             <div class="form-group">
                                <label class="callback-label"><input type="checkbox" id="offline-callback-booked"> Book callback?</label>
                            </div>
                            <div class="form-group hidden" id="offline-callback-scheduler-container">
                                <label>Select Callback Date & Time</label>
                                <div id="offline-calendar-container" class="calendar-container">
                                    <div class="calendar-header">
                                        <button type="button" id="offline-prev-month-btn">&lt;</button>
                                        <span id="offline-month-year-display" class="month-year-display"></span>
                                        <button type="button" id="offline-next-month-btn">&gt;</button>
                                    </div>
                                    <div class="calendar-weekdays">
                                        <div class="weekday">Mon</div><div class="weekday">Tue</div><div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div><div class="weekday">Sun</div>
                                    </div>
                                    <div id="offline-calendar-body" class="calendar-body"></div>
                                </div>
                                <div id="offline-callback-times-container" class="time-picker-container">
                                      <select id="offline-hour-picker"></select>
                                      <span>:</span>
                                      <select id="offline-minute-picker"></select>
                                </div>
                                <input type="hidden" id="offline-callback-details" name="offline-callback-details">
                            </div>
                        </div>
                    </div>
                    <div class="form-step">
                        <h3>Offline: Additional Info</h3>
                        <div class="step-content">
                            <div class="form-group">
                                <label for="additional-info">Enter any additional info</label>
                                <textarea id="additional-info" rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn-primary">Generate Note</button>
                    <button type="reset" class="btn-secondary">Clear Form</button>
                </div>

            </form>
        </section>

        <!-- Output Section -->
        <section class="output-section">
            <h2>Generated Note</h2>
            <textarea id="output-note" readonly placeholder="Your generated note will appear here..."></textarea>
            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
                <button id="copy-button" class="btn-secondary">Copy to Clipboard</button>
                <span id="copy-feedback"></span>
            </div>
        </section>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DATA ---
            const delayReasonsData = [
                { id: 'ducting_issue', category: 'Delays', dropdownText: 'External Ducting Issue (12 Weeks)'},
                { id: 'engineer_shortage', category: 'Delays', dropdownText: 'Engineer Shortage (4 Weeks)'},
                { id: 'wayleave_delay', category: 'Delays', dropdownText: 'Wayleave/Permit Delay (8 Weeks)'},
                { id: 'damaged_cabinet', category: 'Delays', dropdownText: 'Damaged Cabinet (12 Weeks)'},
                { id: 'damaged_pole', category: 'Delays', dropdownText: 'Damaged Pole (12 Weeks)'},
                { id: 'developer_delays', category: 'Delays', dropdownText: 'Developer Delays (3 Weeks)'},
                { id: 'duct_cable_stock', category: 'Delays', dropdownText: 'Duct and Cable Stock (3 Weeks)'},
                { id: 'e_d_side_fault', category: 'Delays', dropdownText: 'E-side or D-side Fault (20 Days)'},
                { id: 'hoist_availability', category: 'Delays', dropdownText: 'Hoist Availability (3 Weeks)'},
                { id: 'no_capacity', category: 'Delays', dropdownText: 'No Capacity Available (12 Weeks)'},
                { id: 'planning_design', category: 'Delays', dropdownText: 'Planning and Design (30 Days)'},
                { id: 'ptw_delay', category: 'Delays', dropdownText: 'PTW (Permission to Work) Delay'},
                { id: 'open_exception', category: 'Delays', dropdownText: 'Open Exception (7 Days)'},
                { id: 'routing_issue', category: 'Delays', dropdownText: 'Routing Issue (14 Days)'},
                { id: 'survey_required', category: 'Delays', dropdownText: 'Survey Required (30 Days)'},
                { id: 'tree_cutting', category: 'Delays', dropdownText: 'Tree Cutting (13 Weeks)'},
            ];
            const mockErrorDatabase = [
                { code: '521', description: "Changes to appointment" },
                { code: '523', description: "New appointment required" },
                { code: '524', description: "New appointment required" },
                { code: '525', description: "Changes to appointment" },
                { code: '566', description: "New appointment required" },
                { code: '584', description: "Further work required" },
                { code: '585', description: "Further work required" },
                { code: '586', description: "Survey" },
                { code: '2001', description: "Contact details supplied don't match database" },
                { code: '5045', description: "Changes to appointment" },
                { code: '5197', description: "New appointment required" },
                { code: '5466', description: "Planning and design" },
                { code: '5472', description: "New appointment required" },
                { code: '5742', description: "Survey" },
                { code: '5789', description: "Changes to appointment" },
                { code: '9652-2', description: "Planning and design" },
                { code: '9652-4', description: "Planning and design" },
                { code: '9662', description: "Delayed in Planning" },
                { code: '9775-1', description: "Further work required" },
                { code: '9775-1', description: "New appointment required" },
                { code: '9798', description: "Engineer unable to complete work" },
                { code: '9881', description: "Engineer unable to complete work" },
                { code: '100221', description: "Haven't sent a new appointment within 15 days of request" },
                { code: '100313', description: "No asset for given ALID (order needs to be cancelled and replaced)" },
                { code: '101002', description: "Planning and design" },
                { code: '101003', description: "Awaiting D share routing" },
                { code: '101018', description: "PSTN delay" },
                { code: '101021', description: "Delayed in Planning" },
                { code: '101031', description: "Openreach querying whether to proceed with the order" },
                { code: '101074', description: "Further work required" },
                { code: '101075', description: "Openreach is waiting for information from the CP (Communications Provider)" },
                { code: '101078', description: "Network build status update (Ready to build, Installing, Complete, etc.)" },
                { code: '101082', description: "Line plant delay" },
                { code: '101084', description: "Issues with the underground network" },
                { code: '101092', description: "Required work exceeded the time allocation; new appointment needed" },
                { code: '101093', description: "Further work is needed by Openreach" },
                { code: '101095', description: "Fault on the distribution side network" },
                { code: '101107', description: "Survey" },
                { code: '101110', description: "Safety-related hazard" },
                { code: '101115', description: "Planning and design" },
                { code: '101116', description: "Planning and design" },
                { code: '101130', description: "New appointment required" },
                { code: '101131', description: "New appointment required" },
                { code: '101132', description: "Additional build works impacting order; re-appointment needed" },
                { code: '101133', description: "Additional Traffic Management Act (TMA) impact; re-appointment needed" },
                { code: '101134', description: "Order on waiters list due to network capacity issues" },
                { code: '101146', description: "End Customer provided instructions different to those from the CP" },
                { code: '101147', description: "Engineer missed the slot or was unable to complete the installation" },
                { code: '101148', description: "Engineer missed the slot or was unable to complete the installation" },
                { code: '101153', description: "Engineer missed the slot or was unable to complete the installation" },
                { code: '101158', description: "Appointment missed due to an End Customer missed scenario" },
                { code: '101160', description: "Order passed to Network Addressing Team (NAT) to identify the address" },
                { code: '101161', description: "Order requires a survey (various reasons)" },
                { code: '101163', description: "Delayed in Planning" },
                { code: '101165', description: "The original routing is unavailable; working on an alternative" },
                { code: '101165', description: "Order has been identified as a new site by BT Wholesale" },
                { code: '101166', description: "Planning and design" },
                { code: '101171', description: "Appointment missed due to an End Customer missed scenario" }
            ];

            // --- Element Selectors ---
            const noteForm = document.getElementById('note-form');
            const outputNoteTextarea = document.getElementById('output-note');
            const copyButton = document.getElementById('copy-button');
            const copyFeedbackSpan = document.getElementById('copy-feedback');
            
            // Step containers and paths
            const step1Container = document.getElementById('step-1-container');
            const businessAreaRadios = document.querySelectorAll('input[name="business-area"]');
            const mainWorkflowContainer = document.getElementById('main-workflow-container');
            const offlineWorkflowContainer = document.getElementById('offline-workflow-container');
            const validationYesPath = document.getElementById('validation-yes-path');
            const validationNoPath = document.getElementById('validation-no-path');
            const validationRadios = document.querySelectorAll('input[name="validation"]');

            // Form field selectors
            const custNameInput = document.getElementById('cust-name');
            const accountNumberInput = document.getElementById('account-number');
            const phoneNumberInput = document.getElementById('phone-number');
            const issueSummaryInput = document.getElementById('issue-summary');
            const validationFailReasonInput = document.getElementById('validation-fail-reason');
            
            // Offline workflow selectors
            const delayErrorCodeInput = document.getElementById('delay-error-code');
            const delayReasonSelect = document.getElementById('delay-reason');
            const delayReasonGroup = document.getElementById('delay-reason-group');
            const noDelayCheckbox = document.getElementById('no-delay-checkbox');
            const errorCodeResultsContainer = document.getElementById('error-code-results');
            const addSecondCodeCheckbox = document.getElementById('add-second-code-checkbox');
            const secondErrorCodeContainer = document.getElementById('second-error-code-container');
            const delayErrorCodeInput2 = document.getElementById('delay-error-code-2');
            const errorCodeResultsContainer2 = document.getElementById('error-code-results-2');
            const additionalInfoInput = document.getElementById('additional-info');
            const offlineResolvedCheckbox = document.getElementById('offline-resolved');
            const offlineNumberInput = document.getElementById('offline-number-input');
            const customerAnsweredRadios = document.querySelectorAll('input[name="customer-answered"]');
            const customerVerifiedGroup = document.getElementById('customer-verified-group');

            // Callback selectors (Standard Workflow)
            const callbackBookedCheckbox = document.getElementById('callback-booked');
            const callbackSchedulerContainer = document.getElementById('callback-scheduler-container');
            const callbackDetailsInput = document.getElementById('callback-details');
            const mainHourPicker = document.getElementById('main-hour-picker');
            const mainMinutePicker = document.getElementById('main-minute-picker');
            const monthYearDisplay = document.getElementById('month-year-display');
            const calendarBody = document.getElementById('calendar-body');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');

            // Callback selectors (Offline Workflow)
            const offlineCallbackBookedCheckbox = document.getElementById('offline-callback-booked');
            const offlineCallbackSchedulerContainer = document.getElementById('offline-callback-scheduler-container');
            const offlineCallbackDetailsInput = document.getElementById('offline-callback-details');
            const offlineHourPicker = document.getElementById('offline-hour-picker');
            const offlineMinutePicker = document.getElementById('offline-minute-picker');
            const offlineMonthYearDisplay = document.getElementById('offline-month-year-display');
            const offlineCalendarBody = document.getElementById('offline-calendar-body');
            const offlinePrevMonthBtn = document.getElementById('offline-prev-month-btn');
            const offlineNextMonthBtn = document.getElementById('offline-next-month-btn');
            
            
            // --- INITIALIZATION ---
            
            // Populate delay reasons dropdown
            delayReasonsData.forEach(reason => {
                const option = document.createElement('option');
                option.value = reason.id;
                option.textContent = reason.dropdownText;
                delayReasonSelect.appendChild(option);
            });
            
            // --- Reusable Functions ---

            /**
             * Copies the content of the output note textarea to the clipboard
             * and provides visual feedback to the user.
             */
            const copyNoteToClipboard = () => {
                if (outputNoteTextarea.value.length === 0) return;

                try {
                    outputNoteTextarea.select();
                    outputNoteTextarea.setSelectionRange(0, 99999); // For mobile devices
                    document.execCommand('copy');

                    // Provide success feedback
                    copyFeedbackSpan.textContent = 'Copied!';
                    copyFeedbackSpan.classList.add('show');
                    setTimeout(() => {
                        copyFeedbackSpan.classList.remove('show');
                    }, 2000);
                } catch (e) {
                    console.error('Failed to copy text: ', e);
                    // Provide failure feedback
                    copyFeedbackSpan.textContent = 'Failed to copy!';
                    copyFeedbackSpan.classList.add('show');
                    setTimeout(() => {
                        copyFeedbackSpan.classList.remove('show');
                    }, 2000);
                }
                // Deselect the text after the operation
                window.getSelection().removeAllRanges();
            };
            
            // --- Calendar & Time Picker Logic ---
            let selectedDateMain = null;
            let selectedDateOffline = null;

            const setupTimePicker = (hourPicker, minutePicker, hiddenInput, dateRef, startHour, endHour) => {
                let hourOptions = '';
                let minuteOptions = '';

                // Default hour is the start of the range (e.g., 08)
                const defaultHour = String(startHour).padStart(2, '0');

                for (let i = startHour; i <= endHour; i++) {
                    const hour = String(i).padStart(2, '0');
                    // The selected attribute is added to the defaultHour
                    hourOptions += `<option value="${hour}" ${hour === defaultHour ? 'selected' : ''}>${hour}</option>`;
                }

                // Create minute options in 5-minute increments
                for (let i = 0; i < 60; i += 5) {
                    const minute = String(i).padStart(2, '0');
                     // The selected attribute is added to '00'
                    minuteOptions += `<option value="${minute}" ${minute === '00' ? 'selected' : ''}>${minute}</option>`;
                }

                hourPicker.innerHTML = hourOptions;
                minutePicker.innerHTML = minuteOptions;
                
                const updateHiddenInput = () => {
                    if (dateRef && hourPicker.value && minutePicker.value) {
                        hiddenInput.value = `${dateRef.getFullYear()}-${String(dateRef.getMonth() + 1).padStart(2, '0')}-${String(dateRef.getDate()).padStart(2, '0')} ${hourPicker.value}:${minutePicker.value}`;
                    } else {
                        hiddenInput.value = '';
                    }
                };
                
                // Immediately update the hidden input with the default time
                updateHiddenInput();

                hourPicker.addEventListener('change', updateHiddenInput);
                minutePicker.addEventListener('change', updateHiddenInput);
            };

            const renderCalendar = (year, month, calendarBodyEl, monthYearDisplayEl, onDateSelect) => {
                calendarBodyEl.innerHTML = '';
                const firstDayOfMonth = new Date(year, month, 1);
                const lastDateOfMonth = new Date(year, month + 1, 0);
                const lastDateOfPrevMonth = new Date(year, month, 0);

                monthYearDisplayEl.textContent = firstDayOfMonth.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });

                let firstDayIndex = firstDayOfMonth.getDay(); 
                if (firstDayIndex === 0) firstDayIndex = 7; 

                for (let i = firstDayIndex - 1; i > 0; i--) {
                    const day = lastDateOfPrevMonth.getDate() - i + 1;
                    const cell = document.createElement('div');
                    cell.classList.add('date-cell', 'other-month');
                    cell.textContent = day;
                    calendarBodyEl.appendChild(cell);
                }

                for (let i = 1; i <= lastDateOfMonth.getDate(); i++) {
                    const cell = document.createElement('div');
                    cell.classList.add('date-cell');
                    cell.textContent = i;
                    
                    const today = new Date();
                    if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                        cell.classList.add('today');
                    }

                    cell.addEventListener('click', () => {
                        calendarBodyEl.querySelectorAll('.date-cell.selected').forEach(c => c.classList.remove('selected'));
                        cell.classList.add('selected');
                        const selectedDate = new Date(year, month, i);
                        onDateSelect(selectedDate);
                    });
                    calendarBodyEl.appendChild(cell);
                }
            };
            
            // Setup Main Calendar
            let main_currentDate = new Date();
            let main_currentYear = main_currentDate.getFullYear();
            let main_currentMonth = main_currentDate.getMonth();
            prevMonthBtn.addEventListener('click', () => {
                main_currentMonth--;
                if (main_currentMonth < 0) { main_currentMonth = 11; main_currentYear--; }
                renderCalendar(main_currentYear, main_currentMonth, calendarBody, monthYearDisplay, (date) => {
                     selectedDateMain = date;
                     setupTimePicker(mainHourPicker, mainMinutePicker, callbackDetailsInput, selectedDateMain, 8, 20); // M-Sa 8-8
                });
            });
            nextMonthBtn.addEventListener('click', () => {
                main_currentMonth++;
                if (main_currentMonth > 11) { main_currentMonth = 0; main_currentYear++; }
                renderCalendar(main_currentYear, main_currentMonth, calendarBody, monthYearDisplay, (date) => {
                    selectedDateMain = date;
                    setupTimePicker(mainHourPicker, mainMinutePicker, callbackDetailsInput, selectedDateMain, 8, 20); // M-Sa 8-8
                });
            });

            // Setup Offline Calendar
            let offline_currentDate = new Date();
            let offline_currentYear = offline_currentDate.getFullYear();
            let offline_currentMonth = offline_currentDate.getMonth();
            offlinePrevMonthBtn.addEventListener('click', () => {
                offline_currentMonth--;
                if (offline_currentMonth < 0) { offline_currentMonth = 11; offline_currentYear--; }
                renderCalendar(offline_currentYear, offline_currentMonth, offlineCalendarBody, offlineMonthYearDisplay, (date) => {
                    selectedDateOffline = date;
                    setupTimePicker(offlineHourPicker, offlineMinutePicker, offlineCallbackDetailsInput, selectedDateOffline, 8, 21);
                });
            });
            offlineNextMonthBtn.addEventListener('click', () => {
                offline_currentMonth++;
                if (offline_currentMonth > 11) { offline_currentMonth = 0; offline_currentYear++; }
                renderCalendar(offline_currentYear, offline_currentMonth, offlineCalendarBody, offlineMonthYearDisplay, (date) => {
                    selectedDateOffline = date;
                    setupTimePicker(offlineHourPicker, offlineMinutePicker, offlineCallbackDetailsInput, selectedDateOffline, 8, 21);
                });
            });

            // --- Error Code Search Functionality ---
            const setupSearch = (inputElement, resultsContainer) => {
                inputElement.addEventListener('input', () => {
                    const query = inputElement.value.trim().toLowerCase();
                    resultsContainer.innerHTML = ''; // Clear previous results

                    if (query.length < 1) {
                        resultsContainer.classList.add('hidden');
                        return;
                    }

                    let finalResults = [];
                    const noCodeResult = { code: 'No Code', description: 'No specific error code provided' };

                    // Check if "No Code" itself should be a result
                    if (noCodeResult.code.toLowerCase().includes(query) || noCodeResult.description.toLowerCase().includes(query)) {
                        finalResults.push(noCodeResult);
                    }

                    // Add filtered results from the database
                    const filteredDb = mockErrorDatabase.filter(item =>
                        item.code.toLowerCase().includes(query) || item.description.toLowerCase().includes(query)
                    );
                    finalResults = finalResults.concat(filteredDb);
                    
                    if (finalResults.length > 0) {
                        finalResults.forEach(result => {
                            const item = document.createElement('div');
                            item.classList.add('search-result-item');
                            item.innerHTML = `<strong>${result.code}</strong> - ${result.description}`;
                            item.addEventListener('click', () => {
                                inputElement.value = result.code;
                                resultsContainer.classList.add('hidden');
                            });
                            resultsContainer.appendChild(item);
                        });
                        resultsContainer.classList.remove('hidden');
                    } else {
                         resultsContainer.classList.add('hidden');
                    }
                });
                 // Hide search results when clicking elsewhere
                document.addEventListener('click', (event) => {
                    if (!inputElement.contains(event.target)) {
                       resultsContainer.classList.add('hidden');
                    }
                });
            };

            setupSearch(delayErrorCodeInput, errorCodeResultsContainer);
            setupSearch(delayErrorCodeInput2, errorCodeResultsContainer2);


            // --- EVENT LISTENERS ---

            // 1. Business area selection
            businessAreaRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    const selectedValue = event.target.value;
                    if (selectedValue === 'Offline') {
                        mainWorkflowContainer.classList.add('hidden');
                        offlineWorkflowContainer.classList.remove('hidden');
                        step1Container.classList.add('collapsed');
                    } else {
                        mainWorkflowContainer.classList.remove('hidden');
                        offlineWorkflowContainer.classList.add('hidden');
                        step1Container.classList.remove('collapsed');
                    }
                });
            });

            // 2. Expand/collapse Step 1
            step1Container.querySelector('h3').addEventListener('click', () => {
                step1Container.classList.toggle('collapsed');
            });


            // 3. Validation radio buttons (standard workflow)
            validationRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'yes') {
                        validationYesPath.classList.remove('hidden');
                        validationNoPath.classList.add('hidden');
                    } else {
                        validationNoPath.classList.remove('hidden');
                        validationYesPath.classList.add('hidden');
                    }
                });
            });

            // 4. Conditional logic for Customer Verified section (Offline Workflow)
            customerAnsweredRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'No') {
                        customerVerifiedGroup.classList.add('hidden');
                    } else {
                        customerVerifiedGroup.classList.remove('hidden');
                    }
                });
            });
            
            // 5. Checkbox for second error code
            addSecondCodeCheckbox.addEventListener('change', () => {
                secondErrorCodeContainer.classList.toggle('hidden');
                if (!addSecondCodeCheckbox.checked) {
                    delayErrorCodeInput2.value = ''; // Clear on hide
                }
            });

            // 6. Checkbox for "No Delay?"
            noDelayCheckbox.addEventListener('change', () => {
                if (noDelayCheckbox.checked) {
                    delayReasonGroup.classList.add('hidden');
                    delayReasonSelect.value = ''; // Reset selection
                } else {
                    delayReasonGroup.classList.remove('hidden');
                }
            });


            // 7. Handle form submission
            noteForm.addEventListener('submit', (event) => {
                event.preventDefault();

                const selectedArea = document.querySelector('input[name="business-area"]:checked')?.value;
                let finalNote = '';
                
                const formatLine = (key, value) => `${key.padEnd(20, ' ')}: ${value || 'N/A'}`;

                if (selectedArea === 'Offline') {
                    const delayErrorCode1 = delayErrorCodeInput.value.trim();
                    const delayErrorCode2 = delayErrorCodeInput2.value.trim();
                    
                    let combinedErrorCodes = delayErrorCode1;
                    if (!combinedErrorCodes || combinedErrorCodes === "No Code") {
                        combinedErrorCodes = "No Code Provided";
                    }

                    if(delayErrorCode2 && delayErrorCode2 !== "No Code") {
                        combinedErrorCodes += `, ${delayErrorCode2}`;
                    }

                    let delayReasonText;
                    if (noDelayCheckbox.checked) {
                        delayReasonText = "No Delay";
                    } else {
                        delayReasonText = delayReasonSelect.options[delayReasonSelect.selectedIndex].text;
                    }
                    
                    const preTextSent = document.querySelector('input[name="pre-text-sent"]:checked')?.value || 'N/A';
                    const customerAnswered = document.querySelector('input[name="customer-answered"]:checked')?.value || 'N/A';
                    let customerVerified = document.querySelector('input[name="customer-verified"]:checked')?.value || 'N/A';
                    
                    if (customerAnswered === 'No') {
                        customerVerified = 'No'; // Override if customer didn't answer
                    }
                    
                    const postTextSent = document.querySelector('input[name="post-text-sent"]:checked')?.value || 'N/A';
                    
                    const isResolved = offlineResolvedCheckbox.checked;
                    const numberValue = offlineNumberInput.value.trim();
                    const additionalInfo = additionalInfoInput.value.trim();
                    
                    const callbackBooked = offlineCallbackBookedCheckbox.checked;
                    let callbackDetailsText = 'No';
                     if (callbackBooked && offlineCallbackDetailsInput.value) {
                         const cbDate = new Date(offlineCallbackDetailsInput.value);
                         callbackDetailsText = `Yes - ${cbDate.toLocaleString('en-GB', { dateStyle: 'full', timeStyle: 'short' })}`;
                    } else if (callbackBooked) {
                         callbackDetailsText = `Yes (No time selected)`;
                    }


                    let hashtags = [];
                    if (isResolved) {
                        hashtags.push('#Resolved');
                    }
                    if (numberValue) {
                        hashtags.push(`#${numberValue}`);
                    }
                    
                    const contactAttempts = `Answered: ${customerAnswered} | Verified: ${customerVerified}`;
                    const smsAttempts = `Pre-Text: ${preTextSent} | Post-Text: ${postTextSent}`;

                    finalNote = `
---[ OFFLINE WORKFLOW ]----------------------------------
${formatLine('Business Area', 'Offline')}
${formatLine('Delay Error Code(s)', combinedErrorCodes)}
${formatLine('Delay Reason', delayReasonText.includes('Select') ? 'N/A' : delayReasonText)}
${formatLine('Contact Summary', contactAttempts)}
${formatLine('SMS Summary', smsAttempts)}
${formatLine('Callback Booked', callbackDetailsText)}
${formatLine('Resolution', hashtags.join(' ') || 'N/A')}

---[ ADDITIONAL INFO ]-----------------------------------

${additionalInfo || 'No additional info provided.'}
                    `.trim();

                } else {
                    const validateYes = document.getElementById('validate-yes').checked;
                    if (validateYes) {
                        const customerName = custNameInput.value.trim();
                        const accountNumber = accountNumberInput.value.trim();
                        const phoneNumber = phoneNumberInput.value.trim();
                        const issueSummary = issueSummaryInput.value.trim();
                        const checkedActions = document.querySelectorAll('input[name="action"]:checked');
                        
                        let actionsText = '';
                        if (checkedActions.length > 0) {
                            actionsText = `\n---[ ACTIONS TAKEN ]-------------------------------------\n\n`;
                            checkedActions.forEach(checkbox => {
                                actionsText += `  â€¢ ${checkbox.value}\n`;
                            });
                        }

                        const callbackBooked = callbackBookedCheckbox.checked;
                        let callbackDetailsText = 'No';
                        if (callbackBooked && callbackDetailsInput.value) {
                             const cbDate = new Date(callbackDetailsInput.value);
                             callbackDetailsText = `Yes\n${formatLine('Callback Details', cbDate.toLocaleString('en-GB', { dateStyle: 'full', timeStyle: 'short' }))}`;
                        } else if (callbackBooked) {
                             callbackDetailsText = `Yes (No time selected)`;
                        }

                        finalNote = `
---[ CALL DETAILS ]--------------------------------------
${formatLine('Business Area', selectedArea)}

---[ CUSTOMER & ACCOUNT ]--------------------------------
${formatLine('Customer Name', customerName)}
${formatLine('Account Number', accountNumber)}
${formatLine('Phone Number', phoneNumber)}

---[ ISSUE SUMMARY ]-------------------------------------

${issueSummary || 'No summary provided.'}
${actionsText}
---[ OUTCOME & NEXT STEPS ]------------------------------
${formatLine('Callback Booked', callbackDetailsText)}
`.trim();

                    } else {
                        const reason = validationFailReasonInput.value.trim();
                        finalNote = `
---[ CALL DETAILS ]--------------------------------------
${formatLine('Business Area', selectedArea)}

---[ VALIDATION NOT COMPLETED ]--------------------------

Customer validation was not completed.

Reason:
${reason || 'No reason provided.'}
`.trim();
                    }
                }
                
                outputNoteTextarea.value = finalNote;
                copyNoteToClipboard(); // Auto-copy the note to clipboard
            });

            // 8. Toggle visibility of callback schedulers
            callbackBookedCheckbox.addEventListener('change', () => {
                if (callbackBookedCheckbox.checked) {
                    callbackSchedulerContainer.classList.remove('hidden');
                    renderCalendar(main_currentYear, main_currentMonth, calendarBody, monthYearDisplay, (date) => {
                        selectedDateMain = date;
                        setupTimePicker(mainHourPicker, mainMinutePicker, callbackDetailsInput, selectedDateMain, 8, 20); // M-Sa 8-8
                    });
                } else {
                    callbackSchedulerContainer.classList.add('hidden');
                    callbackDetailsInput.value = '';
                }
            });
            offlineCallbackBookedCheckbox.addEventListener('change', () => {
                if (offlineCallbackBookedCheckbox.checked) {
                    offlineCallbackSchedulerContainer.classList.remove('hidden');
                     renderCalendar(offline_currentYear, offline_currentMonth, offlineCalendarBody, offlineMonthYearDisplay, (date) => {
                        selectedDateOffline = date;
                        setupTimePicker(offlineHourPicker, offlineMinutePicker, offlineCallbackDetailsInput, selectedDateOffline, 8, 21);
                    });
                } else {
                    offlineCallbackSchedulerContainer.classList.add('hidden');
                    offlineCallbackDetailsInput.value = '';
                }
            });

            // 9. Handle the "Copy to Clipboard" button click
            copyButton.addEventListener('click', copyNoteToClipboard);

            // 10. Handle form reset
            noteForm.addEventListener('reset', () => {
                outputNoteTextarea.value = '';
                mainWorkflowContainer.classList.add('hidden');
                offlineWorkflowContainer.classList.add('hidden');
                validationYesPath.classList.add('hidden');
                validationNoPath.classList.add('hidden');
                callbackSchedulerContainer.classList.add('hidden');
                offlineCallbackSchedulerContainer.classList.add('hidden');
                customerVerifiedGroup.classList.remove('hidden');
                step1Container.classList.remove('collapsed');
                addSecondCodeCheckbox.checked = false;
                secondErrorCodeContainer.classList.add('hidden');
                delayErrorCodeInput2.value = '';
                noDelayCheckbox.checked = false;
                delayReasonGroup.classList.remove('hidden');
            });
        });
    </script>
</body>
</html>
